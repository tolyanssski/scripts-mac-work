# AGENTS: базовые ожидания по задачам

Этот файл — шпаргалка по типовым требованиям во всех проектах `~/projects`. Пользуйся им как стартовой инструкцией и дополняй под новую задачу.

## Общие подходы
- Всегда обновляй сущности вместе с инфраструктурой: поля в ent/gorm + миграции Postgres, правки репозиториев, DTO, сервисных слоев, OpenAPI/gRPC, тестов и данных (data-migration скрипты, если нужно проставить значения старым строкам).
- Конфиги дублируй env-переменными: значения должны идти из YAML, но переопределяться через переменные окружения (см. br-billing).
- Локи обязательны при гонках: ключи строятся из сервиса/метода и бизнес-идентификаторов (userID, accountID, address и т.п.), TTL ставят только если явно указано.
- Побочные эффекты (Kafka, e-mail/SMS, внешние вызовы) выноси из БД-транзакций; ошибки уведомлений чаще логируются и не прерывают основной флоу.
- При конфликтных мерджах dev/master — сохраняй версию из dev.

## OpenAPI / gRPC
- Ошибки: схемы `Error` выносятся в components, в ответах делаем `$ref`, описания/контент остаются inline. Пустые 200-ответы — схема `Empty`. Это требование повторяется во всех сервисах.
- Перенос `*Request`/`*Response` в `components/schemas`, content inline; теги у методов могут быть переопределены одним значением (Partnership и др.).
- Опциональные поля: если из сервисов приходит пустая строка, в ответе отдаём unset/null. Новые поля в запросах/ответах нужно пробрасывать до бизнес-слоя.
- gRPC методы добавляем вместе с proto-структурами и реализацией сервера; зависимости протягиваем через DI.

## Работа с сущностями и миграциями
- Новые поля: задавай дефолты как в постановке, помни про связанные журналы (например, TransactionJournal). В гугланговых моделях соблюдай nullable/optional типы.
- Новые сущности: полный CRUD в репозиториях, миграции в `migrations`, без FK/edges если явно не просили. Для master_key_id/уникальных индексов делаются отдельные data/DDL-миграции.
- При добавлении уникальных ограничений (crypto_account_links.address, address_links.address и т.п.) — отдельная миграция.
- Data-миграции: присваивание master_key_id строится по шаблону `<lower(currency)>_<blockchain>_<suffix>`.

## Логи и мониторинг
- Логируй ключевые действия и ошибки, но многие ошибки уведомлений/балансов не должны прерывать поток.
- Для Kafka-консумеров в логах ошибок добавляй список топиков.
- HTTP-серверы: middleware на логирование возврата ошибочных статусов.
- Метрики: есть обертки над Victoria Metrics; отправка готовых метрик с лейблами (в т.ч. accountID).

## Документация/тон
- README/описания иногда требуются с легким сарказмом и дружелюбным тоном. Схемы/диаграммы включаются в README, файлы кладутся в корень, ссылки добавляются в текст.

Если новая задача похожа на один из кейсов выше — применяй соответствующий набор действий без повторных подсказок.
